{"openapi":"3.1.0","info":{"title":"FastAPI","version":"0.1.0"},"paths":{"/emails/analyze_eml":{"post":{"summary":"Analyze Eml","description":"Analyze an uploaded .eml and return a breakdown: { 'from', 'subject', 'text', 'patient_id' }.\nThe route first uses deterministic heuristics to find patient id (numeric id or 5-digit code), then falls back to AI extraction.","operationId":"analyze_eml_emails_analyze_eml_post","requestBody":{"content":{"multipart/form-data":{"schema":{"$ref":"#/components/schemas/Body_analyze_eml_emails_analyze_eml_post"}}},"required":true},"responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/init_db":{"post":{"summary":"Init Db","description":"Create sample `doktores` table and populate five entries.","operationId":"init_db_init_db_post","responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}}}}},"/doktores_db":{"get":{"summary":"Doktores Db","description":"Fetch doktores from the SQLite database file `spitex.db`.","operationId":"doktores_db_doktores_db_get","responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}}}}},"/patients_db":{"get":{"summary":"Patients Db","description":"Fetch patients from the DB, including their unique code.","operationId":"patients_db_patients_db_get","responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}}}}},"/users_db":{"get":{"summary":"Users Db","description":"Fetch users/login entries from the DB.","operationId":"users_db_users_db_get","responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}}}}},"/examples/init":{"post":{"summary":"Examples Init","description":"Create the `examples/pdfs` directory and generate sample PDFs (requires reportlab).","operationId":"examples_init_examples_init_post","responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}}}}},"/patients/{patient_identifier}/documents":{"get":{"summary":"List Patient Documents","description":"List documents (PDFs) for a given patient identifier (id or code).","operationId":"list_patient_documents_patients__patient_identifier__documents_get","parameters":[{"name":"patient_identifier","in":"path","required":true,"schema":{"type":"string","title":"Patient Identifier"}}],"responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/patients/{patient_identifier}/documents/upload":{"post":{"summary":"Upload Patient Document","description":"Upload a PDF and attach it to a patient (stored as file on disk and BLOB in DB for backward compatibility).","operationId":"upload_patient_document_patients__patient_identifier__documents_upload_post","parameters":[{"name":"patient_identifier","in":"path","required":true,"schema":{"type":"string","title":"Patient Identifier"}}],"requestBody":{"required":true,"content":{"multipart/form-data":{"schema":{"$ref":"#/components/schemas/Body_upload_patient_document_patients__patient_identifier__documents_upload_post"}}}},"responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/patients/{patient_identifier}/documents/{filename}":{"get":{"summary":"Download Patient Document","description":"Download a named PDF attached to a patient (identifier can be numeric id or code).","operationId":"download_patient_document_patients__patient_identifier__documents__filename__get","parameters":[{"name":"patient_identifier","in":"path","required":true,"schema":{"type":"string","title":"Patient Identifier"}},{"name":"filename","in":"path","required":true,"schema":{"type":"string","title":"Filename"}}],"responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/examples/populate_documents":{"post":{"summary":"Populate Documents","description":"Populate the `documents` table: attach 2..3 example PDFs to each patient.\n\n- If there are fewer than `min_per_patient` documents for a patient, this endpoint\n  uploads additional example PDFs (from `examples/pdfs`) until the patient has\n  at least `min_per_patient` docs, up to `max_per_patient`.\n- Returns summary of insertions.","operationId":"populate_documents_examples_populate_documents_post","parameters":[{"name":"min_per_patient","in":"query","required":false,"schema":{"type":"integer","default":2,"title":"Min Per Patient"}},{"name":"max_per_patient","in":"query","required":false,"schema":{"type":"integer","default":3,"title":"Max Per Patient"}}],"responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/examples/populate_emails":{"post":{"summary":"Populate Emails","description":"Create `count` example emails (default 5), each with a PDF attachment.\n\nAttachments are taken from `examples/pdfs` and emails are assigned to random patients.\n\nImportant: emails are stored as .eml files on disk only and NOT inserted into the database.","operationId":"populate_emails_examples_populate_emails_post","parameters":[{"name":"count","in":"query","required":false,"schema":{"type":"integer","default":5,"title":"Count"}}],"responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/emails/upload":{"post":{"summary":"Upload Eml","description":"Upload an .eml file. Attempt to parse patient id (from Subject or body) and\nstore the .eml in storage/emails/{patient_id}/ or storage/emails/unsorted when unknown.\nReturns metadata about the stored file and any parsed fields.","operationId":"upload_eml_emails_upload_post","requestBody":{"content":{"multipart/form-data":{"schema":{"$ref":"#/components/schemas/Body_upload_eml_emails_upload_post"}}},"required":true},"responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/emails/extract_and_fill_template":{"post":{"summary":"Extract And Fill Template","description":"Accept an uploaded .eml, CSV, PDF, or plain text and try to extract any medication prescriptions.\nIf found, fill the Excel template `Medikamentenliste_Arzt.xlsx` and return the filled workbook.\n- file: optional uploaded file (.eml, .csv, .pdf, .txt)\n- text: optional raw text input\n- as_zip: if true, return a zip containing the filled xlsx and original CSV (if any)\n- template: optional path to the workbook template; defaults to examples/Medikamentenliste_Arzt.xlsx","operationId":"extract_and_fill_template_emails_extract_and_fill_template_post","parameters":[{"name":"text","in":"query","required":false,"schema":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"Text"}},{"name":"as_zip","in":"query","required":false,"schema":{"type":"boolean","default":true,"title":"As Zip"}},{"name":"template","in":"query","required":false,"schema":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"Template"}}],"requestBody":{"content":{"multipart/form-data":{"schema":{"$ref":"#/components/schemas/Body_extract_and_fill_template_emails_extract_and_fill_template_post"}}}},"responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/emails/extract_ui":{"get":{"summary":"Extract Ui","description":"Simple HTML form to browse and upload a file to /emails/extract_and_fill_template.","operationId":"extract_ui_emails_extract_ui_get","responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}}}}},"/examples/create_patient_samples":{"post":{"summary":"Create Patient Samples","description":"Create `count` sample files (PDF + CSV + TXT) based on random patients and store them in `examples/samples/`.","operationId":"create_patient_samples_examples_create_patient_samples_post","parameters":[{"name":"count","in":"query","required":false,"schema":{"type":"integer","default":5,"title":"Count"}}],"responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/emails/sort_unsorted":{"post":{"summary":"Sort Unsorted Emails","description":"Auto-sort .eml files in `storage/emails/unsorted`.\n\n- Tries to detect a patient id (from Subject or body) or match patient name\n  (from `patients` table) in the subject/body.\n- If a match is found, moves the .eml into `storage/emails/{patient_id}/`.\n- Parameters:\n  - dry_run: if true, don't move files, only report what would be done\n  - limit: optional max number of files to process","operationId":"sort_unsorted_emails_emails_sort_unsorted_post","parameters":[{"name":"dry_run","in":"query","required":false,"schema":{"type":"boolean","default":false,"title":"Dry Run"}},{"name":"limit","in":"query","required":false,"schema":{"anyOf":[{"type":"integer"},{"type":"null"}],"title":"Limit"}}],"responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/patients/{patient_identifier}/emails":{"get":{"summary":"List Patient Emails","description":"List .eml files for a patient identifier (code or numeric id).","operationId":"list_patient_emails_patients__patient_identifier__emails_get","parameters":[{"name":"patient_identifier","in":"path","required":true,"schema":{"type":"string","title":"Patient Identifier"}}],"responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/patients/{patient_identifier}/emails/{filename}/download":{"get":{"summary":"Download Eml File","description":"Download a stored .eml by patient identifier and filename.","operationId":"download_eml_file_patients__patient_identifier__emails__filename__download_get","parameters":[{"name":"patient_identifier","in":"path","required":true,"schema":{"type":"string","title":"Patient Identifier"}},{"name":"filename","in":"path","required":true,"schema":{"type":"string","title":"Filename"}}],"responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/patients/{patient_identifier}/emails/{filename}/attachment":{"get":{"summary":"Download Email Attachment By File","description":"Download the first attachment from a stored .eml file for a patient.","operationId":"download_email_attachment_by_file_patients__patient_identifier__emails__filename__attachment_get","parameters":[{"name":"patient_identifier","in":"path","required":true,"schema":{"type":"string","title":"Patient Identifier"}},{"name":"filename","in":"path","required":true,"schema":{"type":"string","title":"Filename"}}],"responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/chat":{"post":{"summary":"Chat","description":"General chat endpoint. If `task` == 'parse_medlist' (or 'parse_csv'), the endpoint\nexpects a `csv` body and returns both the original CSV and an AI-standardized CSV\nthat extracts medication rows. Otherwise, behaves like a normal chat.","operationId":"chat_chat_post","parameters":[{"name":"message","in":"query","required":false,"schema":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"Message"}},{"name":"task","in":"query","required":false,"schema":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"Task"}},{"name":"csv","in":"query","required":false,"schema":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"Csv"}}],"responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}}},"components":{"schemas":{"Body_analyze_eml_emails_analyze_eml_post":{"properties":{"file":{"type":"string","format":"binary","title":"File"}},"type":"object","required":["file"],"title":"Body_analyze_eml_emails_analyze_eml_post"},"Body_extract_and_fill_template_emails_extract_and_fill_template_post":{"properties":{"file":{"anyOf":[{"type":"string","format":"binary"},{"type":"null"}],"title":"File"}},"type":"object","title":"Body_extract_and_fill_template_emails_extract_and_fill_template_post"},"Body_upload_eml_emails_upload_post":{"properties":{"file":{"type":"string","format":"binary","title":"File"}},"type":"object","required":["file"],"title":"Body_upload_eml_emails_upload_post"},"Body_upload_patient_document_patients__patient_identifier__documents_upload_post":{"properties":{"file":{"type":"string","format":"binary","title":"File"}},"type":"object","required":["file"],"title":"Body_upload_patient_document_patients__patient_identifier__documents_upload_post"},"HTTPValidationError":{"properties":{"detail":{"items":{"$ref":"#/components/schemas/ValidationError"},"type":"array","title":"Detail"}},"type":"object","title":"HTTPValidationError"},"ValidationError":{"properties":{"loc":{"items":{"anyOf":[{"type":"string"},{"type":"integer"}]},"type":"array","title":"Location"},"msg":{"type":"string","title":"Message"},"type":{"type":"string","title":"Error Type"}},"type":"object","required":["loc","msg","type"],"title":"ValidationError"}}}}